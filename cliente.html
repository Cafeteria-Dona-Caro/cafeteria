<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mi pedido â€“ Cafecaro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #222 0, #050505 55%);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 14px 16px;
      background: rgba(0,0,0,0.8);
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header .sub {
      font-size: 12px;
      opacity: 0.8;
    }
    header .branch {
      font-size: 13px;
      opacity: 0.9;
      text-align: right;
    }
    main {
      flex: 1;
      padding: 16px;
      max-width: 640px;
      margin: 0 auto;
      width: 100%;
    }
    .card {
      background: rgba(18,18,18,0.95);
      border-radius: 16px;
      border: 1px solid #333;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }
    .section-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.8;
      margin-bottom: 6px;
    }
    .mesa-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #1e272e;
      font-size: 14px;
    }
    .mesa-chip span {
      font-weight: 600;
      font-size: 16px;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      margin-top: 8px;
    }
    .status-abierta {
      background: #ffab00;
      color: #000;
    }
    .status-en_preparacion {
      background: #2962ff;
      color: #fff;
    }
    .status-lista {
      background: #00c853;
      color: #000;
    }
    .status-cerrada {
      background: #757575;
      color: #fff;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }
    .order-meta {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 4px;
    }
    .items-list {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 6px 0;
      border-bottom: 1px dashed #333;
      gap: 10px;
    }
    .item:last-child {
      border-bottom: none;
    }
    .item-main {
      flex: 1;
    }
    .item-name {
      font-weight: 500;
    }
    .item-notes {
      font-size: 12px;
      opacity: 0.8;
    }
    .item-qty {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 2px;
    }
    .item-status-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .item-pendiente {
      background: #ffab00;
      color: #000;
    }
    .item-en_preparacion {
      background: #2962ff;
      color: #fff;
    }
    .item-listo {
      background: #00c853;
      color: #000;
    }
    .item-cancelado {
      background: #b71c1c;
      color: #fff;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 15px;
      font-weight: 600;
    }
    .status-text {
      margin-top: 10px;
      font-size: 13px;
      opacity: 0.9;
    }
    .status-text strong {
      font-weight: 600;
    }
    .helper {
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.8;
    }
    .input-card {
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(18,18,18,0.95);
      border: 1px solid #333;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }
    input {
      border-radius: 8px;
      border: none;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
      background: #222;
      color: #f5f5f5;
      flex: 1;
    }
    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #00c853;
      color: #000;
      white-space: nowrap;
    }
    .status-bar {
      font-size: 12px;
      opacity: 0.85;
      padding: 6px 16px;
      border-top: 1px solid #222;
      background: #050505;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Cafecaro</h1>
      <div class="sub">Seguimiento de tu pedido</div>
    </div>
    <div class="branch" id="branchLabel"></div>
  </header>

  <main>
    <div class="input-card" id="mesaInputCard">
      <div class="section-title">Tu mesa</div>
      <p style="font-size:13px;opacity:0.9;margin:0;">
        Ingresa tu nÃºmero de mesa o escanea un QR que ya lo traiga en el enlace.
      </p>
      <div class="input-row">
        <input type="number" id="mesaInput" min="1" placeholder="Ej. 5" />
        <button id="usarMesaBtn">Ver pedido</button>
      </div>
    </div>

    <div id="orderCard" class="card" style="display:none;">
      <div class="section-title">Resumen de tu pedido</div>

      <div class="mesa-chip">
        Mesa <span id="mesaLabel">-</span>
      </div>

      <div id="orderStatusPill" class="status-pill status-abierta" style="display:none;">
        <span class="status-dot"></span>
        <span id="orderStatusText">Abierta</span>
      </div>

      <div class="order-meta" id="orderMeta"></div>

      <div class="items-list" id="itemsList">
        <!-- Items -->
      </div>

      <div class="total-row">
        <span>Total estimado</span>
        <span id="orderTotal">$0.00</span>
      </div>

      <div class="status-text" id="friendlyStatus"></div>
      <div class="helper">
        Si tienes dudas, puedes mostrar esta pantalla a tu mesero. ðŸ˜Š
      </div>
    </div>

    <div id="emptyState" class="card" style="margin-top:8px;display:none;">
      <div class="section-title">Sin pedido activo</div>
      <p style="font-size:14px;opacity:0.9;margin:0 0 6px;">
        No encontramos un pedido activo para tu mesa.
      </p>
      <p style="font-size:13px;opacity:0.8;margin:0;">
        Si ya hiciste un pedido, espera unos segundos o confirma con tu mesero que haya registrado tu mesa correctamente.
      </p>
    </div>
  </main>

  <div class="status-bar" id="statusText">Esperando nÃºmero de mesa...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      onSnapshot,
      query,
      orderBy,
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // === Config de tu proyecto Cafecaro ===
    const firebaseConfig = {
      apiKey: "AIzaSyDbxe3uCqt-VnhgFW8sd8uJZ5Wg8oQ0b6Y",
      authDomain: "cafecaro-af23b.firebaseapp.com",
      projectId: "cafecaro-af23b",
      storageBucket: "cafecaro-af23b.firebasestorage.app",
      messagingSenderId: "534231921780",
      appId: "1:534231921780:web:f3702e23c024c14c0c8d21",
      measurementId: "G-JC720XBF92"
    };

    const BRANCH_ID = "cafecaro-centro";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const branchLabel = document.getElementById("branchLabel");
    const statusText = document.getElementById("statusText");
    const mesaInputCard = document.getElementById("mesaInputCard");
    const mesaInput = document.getElementById("mesaInput");
    const usarMesaBtn = document.getElementById("usarMesaBtn");

    const orderCard = document.getElementById("orderCard");
    const mesaLabel = document.getElementById("mesaLabel");
    const orderStatusPill = document.getElementById("orderStatusPill");
    const orderStatusText = document.getElementById("orderStatusText");
    const orderMeta = document.getElementById("orderMeta");
    const itemsList = document.getElementById("itemsList");
    const orderTotalEl = document.getElementById("orderTotal");
    const friendlyStatus = document.getElementById("friendlyStatus");
    const emptyState = document.getElementById("emptyState");

    branchLabel.textContent = `Sucursal: ${BRANCH_ID}`;

    let currentMesa = null;
    let unsubscribeOrders = null;
    let unsubscribeItems = null;
    let currentOrderId = null;

    function setStatus(msg) {
      statusText.textContent = msg;
    }

    function formatCurrency(n) {
      return `$${(n || 0).toFixed(2)}`;
    }

    function formatStatusLabel(status) {
      switch (status) {
        case "abierta": return "Pedido registrado";
        case "en_preparacion": return "En preparaciÃ³n";
        case "lista": return "Listo";
        case "cerrada": return "Cuenta cerrada";
        default: return status;
      }
    }

    function formatFriendlyMessage(status) {
      switch (status) {
        case "abierta":
          return "Tu pedido ha sido registrado y se enviarÃ¡ a cocina en breve.";
        case "en_preparacion":
          return "Tu pedido estÃ¡ siendo preparado en cocina. ðŸŽ¯";
        case "lista":
          return "Â¡Tu pedido estÃ¡ listo! En cualquier momento te lo llevan a la mesa. ðŸ¥¤";
        case "cerrada":
          return "Este pedido ya fue cerrado. Gracias por tu visita. ðŸ’š";
        default:
          return "Tu pedido estÃ¡ siendo atendido.";
      }
    }

    function applyStatusPill(status) {
      orderStatusPill.className = "status-pill";
      orderStatusPill.classList.add(`status-${status}`);
      orderStatusText.textContent = formatStatusLabel(status);
      orderStatusPill.style.display = "inline-flex";
      friendlyStatus.textContent = formatFriendlyMessage(status);
    }

    // Escuchar items en tiempo real
    function listenOrderItems(orderId) {
      if (unsubscribeItems) {
        unsubscribeItems();
        unsubscribeItems = null;
      }

      if (!orderId) {
        itemsList.innerHTML = "";
        return;
      }

      const itemsRef = collection(db, "branches", BRANCH_ID, "orders", orderId, "items");
      const qItems = query(itemsRef, orderBy("createdAt", "asc"));

      unsubscribeItems = onSnapshot(
        qItems,
        snapshot => {
          itemsList.innerHTML = "";
          if (snapshot.size === 0) {
            itemsList.innerHTML = "<em style='font-size:13px;opacity:0.8;'>Tu pedido aÃºn no tiene productos.</em>";
            return;
          }

          let subtotal = 0;

          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const lineTotal = (data.totalPrice ?? (data.unitPrice ?? 0) * (data.qty ?? 1));
            subtotal += lineTotal;

            const itemEl = document.createElement("div");
            itemEl.className = "item";

            const statusClass = `item-${data.status || "pendiente"}`;

            itemEl.innerHTML = `
              <div class="item-main">
                <div class="item-name">${data.productName ?? "Producto"}</div>
                <div class="item-qty">x${data.qty ?? 1}</div>
                ${data.notes ? `<div class="item-notes">Nota: ${data.notes}</div>` : ""}
              </div>
              <div>
                <div class="item-status-pill ${statusClass}">
                  ${data.status ?? "pendiente"}
                </div>
                <div style="font-size:12px;margin-top:4px;text-align:right;opacity:0.9;">
                  ${formatCurrency(lineTotal)}
                </div>
              </div>
            `;

            itemsList.appendChild(itemEl);
          });

          orderTotalEl.textContent = formatCurrency(subtotal);
        },
        err => {
          console.error("Error escuchando items:", err);
        }
      );
    }

    // Escuchar Ã³rdenes y elegir la mÃ¡s reciente para esa mesa
    function listenOrdersForMesa(mesaNumber) {
      if (unsubscribeOrders) {
        unsubscribeOrders();
        unsubscribeOrders = null;
      }
      if (unsubscribeItems) {
        unsubscribeItems();
        unsubscribeItems = null;
      }

      const ordersRef = collection(db, "branches", BRANCH_ID, "orders");
      const qOrders = query(
        ordersRef,
        orderBy("createdAt", "desc")
      );

      setStatus("Buscando pedido para tu mesa...");

      unsubscribeOrders = onSnapshot(
        qOrders,
        snapshot => {
          const activeStatuses = ["abierta", "en_preparacion", "lista", "cerrada"];

          const docs = snapshot.docs.filter(d => {
            const data = d.data();
            return data.tableNumber === mesaNumber && activeStatuses.includes(data.status);
          });

          if (docs.length === 0) {
            // Sin pedido
            currentOrderId = null;
            orderCard.style.display = "none";
            emptyState.style.display = "block";
            setStatus("Sin pedido activo para esta mesa.");
            return;
          }

          const docSnap = docs[0]; // el mÃ¡s reciente
          const data = docSnap.data();
          currentOrderId = docSnap.id;

          mesaLabel.textContent = mesaNumber;
          orderMeta.innerHTML = `
            Pedido: <strong>${currentOrderId}</strong><br>
            Estado interno: ${data.status ?? "desconocido"}
          `;

          orderCard.style.display = "block";
          emptyState.style.display = "none";

          applyStatusPill(data.status || "abierta");
          setStatus("Actualizando tu pedido en tiempo real...");
          listenOrderItems(currentOrderId);
        },
        err => {
          console.error("Error escuchando Ã³rdenes:", err);
          setStatus("Error al consultar tu pedido. Intenta mÃ¡s tarde.");
        }
      );
    }

    function startForMesa(mesaNumber) {
      currentMesa = mesaNumber;
      mesaLabel.textContent = mesaNumber;
      mesaInput.value = mesaNumber;
      mesaInputCard.style.display = "none";
      listenOrdersForMesa(mesaNumber);
    }

    // Leer mesa desde la URL: ?mesa=5
    function getMesaFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const mesaStr = params.get("mesa");
      if (!mesaStr) return null;
      const num = parseInt(mesaStr, 10);
      return Number.isFinite(num) && num > 0 ? num : null;
    }

    usarMesaBtn.addEventListener("click", () => {
      const val = parseInt(mesaInput.value, 10);
      if (!val || val <= 0) {
        alert("Escribe un nÃºmero de mesa vÃ¡lido.");
        return;
      }
      startForMesa(val);
    });

    // Auto-inicio si la mesa viene en la URL
    const mesaFromUrl = getMesaFromUrl();
    if (mesaFromUrl) {
      startForMesa(mesaFromUrl);
    } else {
      setStatus("Escribe tu nÃºmero de mesa para consultar el pedido.");
    }
  </script>
</body>
</html>
