<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cafecaro â€“ Pedido del Cliente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <style>
    /* === RESET === */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #fafafa;
      color: #222;
    }

    @media (max-width: 768px) {
      body { font-size: 14px; }
    }
    @media (min-width: 769px) {
      body { font-size: 15px; }
    }

    /* HEADER */
    header {
      background: #ffffff;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    #customerNameInput {
      width: 150px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 13px;
    }

    /* GRID DE PRODUCTOS */
    .products-grid {
      padding: 16px;
      display: grid;
      gap: 16px;
    }
    @media (max-width: 768px) {
      .products-grid { grid-template-columns: 1fr; }
    }
    @media (min-width: 769px) {
      .products-grid { grid-template-columns: repeat(3, 1fr); }
    }

    .product-card {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #eee;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .product-card:active {
      transform: scale(0.98);
    }
    .product-img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      background: #ddd;
    }
    .product-body {
      padding: 12px;
    }
    .product-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .product-price {
      color: #00a650;
      font-weight: bold;
      font-size: 14px;
      margin-top: 6px;
    }

    /* CARRITO FLOTANTE */
    #cartButton {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: #00c853;
      padding: 12px 20px;
      border-radius: 30px;
      color: #000;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      cursor: pointer;
      z-index: 20;
    }

    /* MODAL DE PRODUCTO */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
      z-index: 30;
    }
    .modal.active { display: flex; }

    .modal-content {
      background: #fff;
      width: 100%;
      max-width: 360px;
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-content h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .qty-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .qty-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .qty-controls button {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: #eee;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
    }
    .modal-add-btn {
      padding: 10px;
      background: #00c853;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      color: #000;
      cursor: pointer;
      font-size: 15px;
    }

    /* CHAT CLIENTE */
    #chatBox {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #ddd;
      padding: 8px;
      display: none;
      flex-direction: column;
      max-height: 50vh;
      overflow-y: auto;
      z-index: 15;
    }
    .chat-message {
      background: #e8f5e9;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>

<header>
  <h1>Cafecaro</h1>
  <input type="text" id="customerNameInput" placeholder="Tu nombre (opcional)" />
</header>

<div class="products-grid" id="productsGrid"></div>

<!-- BotÃ³n de carrito -->
<div id="cartButton">ðŸ›’ Carrito (0)</div>

<!-- Modal producto -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <div id="modalPrice" style="font-weight:bold; color:#00a650;"></div>
    
    <textarea id="modalNotes" placeholder="Notas (opcional)" 
      style="width:100%; height:60px; border:1px solid #ccc; border-radius:8px; padding:6px;"></textarea>
    
    <div class="qty-row">
      <div>Cantidad:</div>
      <div class="qty-controls">
        <button id="qtyMinus">-</button>
        <span id="qtyValue">1</span>
        <button id="qtyPlus">+</button>
      </div>
    </div>

    <button class="modal-add-btn" id="addToCartBtn">Agregar al carrito</button>
  </div>
</div>

<!-- Chat cliente -->
<div id="chatBox"></div>

<!-- BotÃ³n para hablar con mesero -->
<div style="
  position:fixed;
  bottom:80px;
  left:20px;
  background:#2962ff;
  color:#fff;
  padding:12px 16px;
  border-radius:30px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
  z-index:20;
" onclick="clientSendMessage()">
  ðŸ—¨ Hablar con mesero
</div>

<!-- ============================= -->
<!--  FIREBASE + LÃ“GICA CLIENTE   -->
<!-- ============================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc,
    doc, updateDoc, serverTimestamp, onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import {
    getAuth,
    signInAnonymously
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  // === CONFIG FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyDbxe3uCqt-VnhgFW8sd8uJZ5Wg8oQ0b6Y",
    authDomain: "cafecaro-af23b.firebaseapp.com",
    projectId: "cafecaro-af23b",
    storageBucket: "cafecaro-af23b.firebasestorage.app",
    messagingSenderId: "534231921780",
    appId: "1:534231921780:web:f3702e23c024c14c0c8d21"
  };

  const BRANCH_ID = "cafecaro-centro";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Login anÃ³nimo inicial
  signInAnonymously(auth).catch((err) => {
    console.error("Error en auth anÃ³nima inicial:", err);
  });

  // Asegurar sesiÃ³n antes de escribir
  async function ensureSignedIn() {
    if (!auth.currentUser) {
      await signInAnonymously(auth);
    }
  }

  // === VARIABLES GLOBALES ===
  const urlParams = new URLSearchParams(window.location.search);
  const mesa = urlParams.get("mesa") || "sin_mesa";

  let cart = [];     // [{id, productName, unitPrice, qty, notes}]
  let selectedProduct = null;
  let activeOrderId = localStorage.getItem("cafecaro_active_order_" + mesa) || null;

  const productsGrid = document.getElementById("productsGrid");
  const productModal = document.getElementById("productModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalPrice = document.getElementById("modalPrice");
  const modalNotes = document.getElementById("modalNotes");
  const qtyMinus = document.getElementById("qtyMinus");
  const qtyPlus = document.getElementById("qtyPlus");
  const qtyValue = document.getElementById("qtyValue");
  const addToCartBtn = document.getElementById("addToCartBtn");
  const cartButton = document.getElementById("cartButton");
  const chatBox = document.getElementById("chatBox");

  function formatCurrency(n) {
    return `$${(n || 0).toFixed(2)}`;
  }

  /* ===============================
     CARGAR PRODUCTOS
  =============================== */
  async function loadProducts() {
    productsGrid.innerHTML = "<p style='opacity:0.6;'>Cargando menÃº...</p>";

    const ref = collection(db, "branches", BRANCH_ID, "products");
    const snap = await getDocs(ref);

    productsGrid.innerHTML = "";

    if (snap.empty) {
      productsGrid.innerHTML = "<p style='opacity:0.6;'>No hay productos en el menÃº.</p>";
      return;
    }

    snap.forEach(docSnap => {
      const p = docSnap.data();
      const id = docSnap.id;

      const card = document.createElement("div");
      card.className = "product-card";
      card.onclick = () => openProduct(id, p);

      card.innerHTML = `
        <img src="${p.imgUrl || "https://via.placeholder.com/300"}" class="product-img">
        <div class="product-body">
          <div class="product-title">${p.name}</div>
          <div class="product-price">${formatCurrency(p.basePrice || 0)}</div>
        </div>
      `;

      productsGrid.appendChild(card);
    });
  }

  loadProducts();

  /* ===============================
     MODAL PRODUCTO
  =============================== */
  function openProduct(id, p) {
    selectedProduct = { id, ...p };
    modalTitle.textContent = p.name;
    modalPrice.textContent = formatCurrency(p.basePrice || 0);
    modalNotes.value = "";
    qtyValue.textContent = "1";
    productModal.classList.add("active");
  }

  productModal.onclick = (e) => {
    if (e.target === productModal) {
      productModal.classList.remove("active");
    }
  };

  qtyMinus.onclick = () => {
    let v = parseInt(qtyValue.textContent);
    if (v > 1) qtyValue.textContent = v - 1;
  };
  qtyPlus.onclick = () => {
    let v = parseInt(qtyValue.textContent);
    qtyValue.textContent = v + 1;
  };

  addToCartBtn.onclick = () => {
    const qty = parseInt(qtyValue.textContent);
    const notes = modalNotes.value.trim();

    cart.push({
      id: selectedProduct.id,
      productName: selectedProduct.name,
      unitPrice: selectedProduct.basePrice,
      qty,
      notes
    });

    productModal.classList.remove("active");
    updateCartButton();
    saveCartLocal();
  };

  /* ===============================
     CARRITO
  =============================== */
  function updateCartButton() {
    let totalQty = cart.reduce((acc, item) => acc + item.qty, 0);
    cartButton.textContent = `ðŸ›’ Carrito (${totalQty})`;
  }

  cartButton.onclick = () => openCart();

  function openCart() {
    let html = `
      <div style="padding:20px;background:#fff;position:fixed;top:0;left:0;right:0;bottom:0;overflow:auto;">
        <h2>Tu pedido â€“ Mesa ${mesa}</h2>
    `;

    if (cart.length === 0) {
      html += "<p>No has agregado productos.</p>";
    } else {
      cart.forEach((item, idx) => {
        html += `
          <div style="padding:10px 0;border-bottom:1px solid #eee;">
            <strong>${item.productName}</strong><br>
            Cant: ${item.qty} â€“ ${formatCurrency(item.unitPrice * item.qty)}<br>
            ${item.notes ? "Nota: " + item.notes : ""}
            <br><button onclick="removeItem(${idx})" style="margin-top:5px;">Eliminar</button>
          </div>
        `;
      });

      const total = cart.reduce((acc, i) => acc + i.unitPrice * i.qty, 0);
      html += `
        <h3>Total: ${formatCurrency(total)}</h3>
        <button onclick="sendOrder()" style="
          background:#00c853;
          padding:12px 20px;
          border:none;
          border-radius:10px;
          font-size:16px;
          font-weight:700;
        ">Enviar pedido</button>
      `;
    }

    html += `
      <br><br>
      <button onclick="closeCart()" style="margin-top:10px;">Cerrar</button>
      </div>
    `;

    const div = document.createElement("div");
    div.id = "cartView";
    div.style.position = "fixed";
    div.style.inset = "0";
    div.style.background = "rgba(0,0,0,0.45)";
    div.innerHTML = html;

    document.body.appendChild(div);
  }

  window.closeCart = function () {
    const v = document.getElementById("cartView");
    if (v) v.remove();
  };

  window.removeItem = function (idx) {
    cart.splice(idx, 1);
    saveCartLocal();
    closeCart();
    openCart();
    updateCartButton();
  };

  /* ===============================
     ENVIAR PEDIDO
  =============================== */
  window.sendOrder = async function () {
    if (cart.length === 0) return alert("Tu carrito estÃ¡ vacÃ­o.");

    try {
      await ensureSignedIn();
      const user = auth.currentUser;
      const customer = document.getElementById("customerNameInput").value.trim();

      const orderRef = await addDoc(
        collection(db, "branches", BRANCH_ID, "orders"),
        {
          tableNumber: mesa,
          customerName: customer || "",
          customerUid: user ? user.uid : null,
          status: "abierta",
          source: "cliente",
          subtotal: 0,
          tax: 0,
          discount: 0,
          total: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }
      );

      for (let item of cart) {
        await addDoc(
          collection(db, "branches", BRANCH_ID, "orders", orderRef.id, "items"),
          {
            productId: item.id,
            productName: item.productName,
            unitPrice: item.unitPrice,
            qty: item.qty,
            notes: item.notes,
            status: "pendiente",
            createdAt: serverTimestamp()
          }
        );
      }

      await updateDoc(orderRef, { updatedAt: serverTimestamp() });

      afterOrderCreated(orderRef.id);

      cart = [];
      saveCartLocal();
      updateCartButton();
      closeCart();

      alert("Pedido enviado. El mesero estÃ¡ preparando tu orden.");
    } catch (err) {
      console.error("Error al enviar pedido:", err);
      alert("Hubo un problema al enviar tu pedido. Revisa tu conexiÃ³n o intÃ©ntalo de nuevo.");
    }
  };

  /* ===============================
     LOCALSTORAGE CARRITO
  =============================== */
  function saveCartLocal() {
    localStorage.setItem("cafecaro_cart_" + mesa, JSON.stringify(cart));
  }
  function loadCartLocal() {
    const s = localStorage.getItem("cafecaro_cart_" + mesa);
    if (s) cart = JSON.parse(s);
    updateCartButton();
  }

  loadCartLocal();

  /* ===============================
     NOTIFICACIONES CLIENTE
  =============================== */
  function showClientNotification(message) {
    const alertDiv = document.createElement("div");
    alertDiv.style.position = "fixed";
    alertDiv.style.bottom = "80px";
    alertDiv.style.right = "20px";
    alertDiv.style.background = "#00c853";
    alertDiv.style.color = "#000";
    alertDiv.style.padding = "12px 16px";
    alertDiv.style.borderRadius = "12px";
    alertDiv.style.fontWeight = "700";
    alertDiv.style.boxShadow = "0 4px 12px rgba(0,0,0,0.2)";
    alertDiv.style.zIndex = "50";
    alertDiv.textContent = message;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
      alertDiv.style.opacity = "0";
      alertDiv.style.transition = "opacity 0.5s";
      setTimeout(() => alertDiv.remove(), 500);
    }, 2000);
  }

  /* ===============================
     ESTADO EN TIEMPO REAL + CHAT
  =============================== */
  function watchOrderStatus(orderId) {
    const ref = doc(db, "branches", BRANCH_ID, "orders", orderId);

    onSnapshot(ref, (snap) => {
      if (!snap.exists()) return;

      const data = snap.data();
      showClientNotification(`Estado de tu pedido: ${data.status}`);

      if (data.status === "lista") {
        alert("ðŸ½ Tu pedido estÃ¡ listo. El mesero lo llevarÃ¡ a tu mesa.");
      }
    }, (err) => {
      console.error("Error escuchando estado de orden:", err);
    });
  }

  function startChatListener(orderId) {
    const msgsRef = collection(
      db,
      "branches",
      BRANCH_ID,
      "orders",
      orderId,
      "messages"
    );

    chatBox.style.display = "flex";

    onSnapshot(msgsRef, (snap) => {
      chatBox.innerHTML = "";

      if (snap.size === 0) {
        chatBox.innerHTML = "<p style='opacity:0.6;'>No hay mensajes aÃºn.</p>";
        return;
      }

      snap.forEach((docSnap) => {
        const m = docSnap.data();
        const div = document.createElement("div");
        div.className = "chat-message";
        div.innerHTML = m.text;
        chatBox.appendChild(div);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
    }, (err) => {
      console.error("Error escuchando mensajes:", err);
    });
  }

  function afterOrderCreated(orderId) {
    activeOrderId = orderId;
    localStorage.setItem("cafecaro_active_order_" + mesa, orderId);
    watchOrderStatus(orderId);
    startChatListener(orderId);
  }

  // ReconexiÃ³n si ya habÃ­a pedido activo
  if (activeOrderId) {
    watchOrderStatus(activeOrderId);
    startChatListener(activeOrderId);
    showClientNotification("Reconectado al pedido activo.");
  }

  /* ===============================
     MENSAJE DEL CLIENTE AL MESERO
  =============================== */
  window.clientSendMessage = async function () {
    if (!activeOrderId) {
      alert("Primero envÃ­a un pedido para poder hablar con el mesero.");
      return;
    }
    const text = prompt("Escribe tu mensaje para el mesero:");
    if (!text || text.trim() === "") return;

    try {
      await addDoc(
        collection(db, "branches", BRANCH_ID, "orders", activeOrderId, "messages"),
        {
          sender: "cliente",
          text,
          createdAt: serverTimestamp(),
        }
      );
    } catch (err) {
      console.error("Error enviando mensaje de cliente:", err);
      alert("No se pudo enviar el mensaje. Intenta de nuevo.");
    }
  };
</script>

</body>
</html>