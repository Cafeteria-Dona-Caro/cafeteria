<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mesero | Cafecaro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header .sub {
      font-size: 11px;
      opacity: 0.7;
    }
    header .right {
      text-align: right;
      font-size: 12px;
    }
    .role-pill {
      display: inline-block;
      margin-top: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ffecb3;
      color: #8d6e00;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
    }

    @media (min-width: 900px) {
      main {
        flex-direction: row;
      }
    }

    .panel {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 10px;
      margin-bottom: 8px;
    }

    @media (min-width: 900px) {
      .panel-left {
        flex: 1;
        margin-right: 6px;
      }
      .panel-right {
        flex: 1.2;
        margin-left: 6px;
      }
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .small {
      font-size: 11px;
      opacity: 0.7;
    }

    /* Lista de órdenes */
    .orders-list {
      max-height: 60vh;
      overflow-y: auto;
    }

    .order-card {
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafafa;
    }
    .order-card.selected {
      border-color: #2962ff;
      box-shadow: 0 0 0 2px #2962ff22;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-status-abierta { background: #e3f2fd; color: #0d47a1; }
    .badge-status-en_preparacion { background: #fff3e0; color: #e65100; }
    .badge-status-lista { background: #e8f5e9; color: #1b5e20; }
    .badge-status-cerrada { background: #eeeeee; color: #424242; }

    .badge-source-cliente { background: #fce4ec; color: #880e4f; }
    .badge-source-mesero { background: #ede7f6; color: #311b92; }

    .order-main {
      font-size: 13px;
    }
    .order-main strong {
      font-size: 14px;
    }

    .order-meta {
      text-align: right;
      font-size: 11px;
      opacity: 0.7;
    }

    /* Detalle de orden */
    .order-detail-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .detail-items {
      max-height: 30vh;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      margin-bottom: 6px;
    }

    .detail-item-row {
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    .detail-item-row:last-child {
      border-bottom: none;
    }
    .detail-item-row-notes {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .details-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      margin-top: 4px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .btn-small {
      padding: 4px 10px;
      font-size: 11px;
    }
    .btn-primary { background: #2962ff; color: #fff; }
    .btn-success { background: #00c853; color: #000; }
    .btn-warning { background: #ffb300; color: #000; }
    .btn-neutral { background: #eeeeee; color: #333; }

    /* Chat */
    .chat-area {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      max-height: 26vh;
      overflow-y: auto;
      margin-bottom: 4px;
      font-size: 12px;
      background: #fafafa;
    }

    .chat-msg {
      margin-bottom: 4px;
      padding: 4px 6px;
      border-radius: 6px;
      max-width: 80%;
    }
    .chat-msg-cliente {
      background: #e3f2fd;
      margin-right: auto;
    }
    .chat-msg-mesero {
      background: #e8f5e9;
      margin-left: auto;
      text-align: right;
    }
    .chat-meta {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 1px;
    }

    .chat-input-row {
      display: flex;
      gap: 4px;
      margin-top: 2px;
    }
    .chat-input-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 12px;
    }

    .status-bar {
      padding: 8px 12px;
      font-size: 12px;
      border-top: 1px solid #ddd;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Mesero</h1>
      <div class="sub" id="branchLabel">Sucursal: —</div>
    </div>
    <div class="right">
      <div id="currentUserEmail">—</div>
      <div id="currentUserRole" class="role-pill">Verificando rol...</div>
      <button id="logoutBtn" class="btn btn-neutral" style="margin-top:4px;">Salir</button>
    </div>
  </header>

  <main>
    <!-- Panel de órdenes -->
    <section class="panel panel-left">
      <h2>Órdenes en curso</h2>
      <p class="small">
        Verás las órdenes abiertas/en preparación/listas de la sucursal actual.
      </p>
      <div class="orders-list" id="ordersList"></div>
    </section>

    <!-- Panel de detalle -->
    <section class="panel panel-right">
      <h2>Detalle de orden</h2>
      <p class="small" id="noOrderSelected">Selecciona una orden para ver el detalle.</p>

      <div id="orderDetail" style="display:none;">
        <div class="order-detail-header">
          <div>
            <div><strong>Mesa <span id="detailTable"></span></strong></div>
            <div>Cliente: <span id="detailCustomer"></span></div>
            <div>Fuente: <span id="detailSource"></span></div>
          </div>
          <div style="text-align:right;">
            <div>Estado: <span id="detailStatus" class="badge"></span></div>
            <div class="small">Creada: <span id="detailCreatedAt"></span></div>
          </div>
        </div>

        <div class="detail-items" id="detailItems"></div>

        <div class="details-footer">
          <div>Total: <strong id="detailTotal">$0.00</strong></div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;">
            <button class="btn btn-small btn-warning" data-status="en_preparacion">En preparación</button>
            <button class="btn btn-small btn-success" data-status="lista">Lista</button>
            <button class="btn btn-small btn-neutral" data-status="cerrada">Cerrar</button>
          </div>
        </div>

        <hr style="margin:8px 0;">

        <div>
          <div class="small">Chat con cliente (si el pedido vino de cliente.html):</div>
          <div class="chat-area" id="chatArea"></div>
          <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="Escribe un mensaje al cliente..." />
            <button class="btn btn-small btn-primary" id="chatSendBtn">Enviar</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="globalStatus" class="status-bar">Conectando...</div>

  <!-- ============================= -->
  <!--  FIREBASE + LÓGICA MESERO    -->
  <!-- ============================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getAuth,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      onSnapshot,
      updateDoc,
      serverTimestamp,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // === CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyDbxe3uCqt-VnhgFW8sd8uJZ5Wg8d21",
      authDomain: "cafecaro-af23b.firebaseapp.com",
      projectId: "cafecaro-af23b",
      storageBucket: "cafecaro-af23b.firebasestorage.app",
      messagingSenderId: "534231921780",
      appId: "1:534231921780:web:f3702e23c024c14c0c8d21"
    };

    const BRANCH_ID = "cafecaro-centro";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === DOM ===
    const branchLabel = document.getElementById("branchLabel");
    const currentUserEmailEl = document.getElementById("currentUserEmail");
    const currentUserRoleEl = document.getElementById("currentUserRole");
    const logoutBtn = document.getElementById("logoutBtn");
    const globalStatus = document.getElementById("globalStatus");

    const ordersListEl = document.getElementById("ordersList");

    const noOrderSelectedEl = document.getElementById("noOrderSelected");
    const orderDetailEl = document.getElementById("orderDetail");

    const detailTableEl = document.getElementById("detailTable");
    const detailCustomerEl = document.getElementById("detailCustomer");
    const detailSourceEl = document.getElementById("detailSource");
    const detailStatusEl = document.getElementById("detailStatus");
    const detailCreatedAtEl = document.getElementById("detailCreatedAt");
    const detailItemsEl = document.getElementById("detailItems");
    const detailTotalEl = document.getElementById("detailTotal");

    const chatAreaEl = document.getElementById("chatArea");
    const chatInputEl = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");

    branchLabel.textContent = "Sucursal: " + BRANCH_ID;

    let currentOrderId = null;
    let unsubscribeItems = null;
    let unsubscribeMessages = null;

    function setGlobalStatus(msg) {
      globalStatus.textContent = msg;
    }

    // === PROTECCIÓN: SOLO MESERO / ADMIN ===
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUserEmailEl.textContent = user.email || "(sin correo)";

      try {
        const roleDoc = await getDoc(doc(db, "users", user.uid));
        if (!roleDoc.exists()) {
          currentUserRoleEl.textContent = "Sin rol";
          setGlobalStatus("Tu usuario no tiene rol asignado.");
          alert("Tu usuario no tiene rol asignado en Firestore.");
          return;
        }

        const data = roleDoc.data();
        const role = data.role || "sin_rol";
        currentUserRoleEl.textContent = "Rol: " + role;

        if (!(role === "mesero" || role === "admin" || role === "caja")) {
          alert("Acceso restringido. Esta página es solo para mesero/caja/admin.");
          window.location.href = "login.html";
          return;
        }

        setGlobalStatus("Conectado como " + role + ".");
        listenOrders();

      } catch (err) {
        console.error(err);
        setGlobalStatus("Error verificando rol.");
      }
    });

    // === LOGOUT ===
    logoutBtn.onclick = async () => {
      await signOut(auth);
      window.location.href = "login.html";
    };

    // === ESCUCHAR ÓRDENES DE LA SUCURSAL ===
    function listenOrders() {
      // Se pueden filtrar por status != 'cerrada', pero aquí las filtramos en cliente:
      const ordersRef = collection(db, "branches", BRANCH_ID, "orders");
      const qOrders = query(ordersRef, orderBy("createdAt", "desc"));

      onSnapshot(qOrders, (snap) => {
        ordersListEl.innerHTML = "";
        if (snap.empty) {
          ordersListEl.innerHTML = "<p class='small' style='padding:6px;'>No hay órdenes.</p>";
          return;
        }

        snap.forEach(docSnap => {
          const data = docSnap.data();
          const status = data.status || "abierta";
          if (status === "cerrada") {
            // si quieres ver cerradas, quita este if
            return;
          }

          const div = document.createElement("div");
          div.className = "order-card";
          div.dataset.id = docSnap.id;

          const source = data.source || "desconocido";
          const total = data.total ?? data.subtotal ?? 0;

          const created = data.createdAt?.toDate ? data.createdAt.toDate() : null;
          const createdStr = created
            ? created.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
            : "--:--";

          div.innerHTML = `
            <div class="order-main">
              <strong>Mesa ${data.tableNumber || "?"}</strong> – ${data.customerName || "Sin nombre"}<br>
              <span class="badge ${getStatusBadgeClass(status)}">${status}</span>
              ${source === "cliente" ? `<span class="badge badge-source-cliente">cliente</span>` : `<span class="badge badge-source-mesero">mesero</span>`}
            </div>
            <div class="order-meta">
              <div>${createdStr}</div>
              <div>${formatCurrency(total)}</div>
            </div>
          `;

          div.addEventListener("click", () => selectOrder(docSnap.id, data));
          ordersListEl.appendChild(div);
        });

        if (!ordersListEl.hasChildNodes()) {
          ordersListEl.innerHTML = "<p class='small' style='padding:6px;'>No hay órdenes abiertas.</p>";
        }
      }, (err) => {
        console.error(err);
        setGlobalStatus("Error leyendo órdenes.");
      });
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case "abierta": return "badge badge-status-abierta";
        case "en_preparacion": return "badge badge-status-en_preparacion";
        case "lista": return "badge badge-status-lista";
        case "cerrada": return "badge badge-status-cerrada";
        default: return "badge";
      }
    }

    function formatCurrency(n) {
      return "$" + (n || 0).toFixed(2);
    }

    // === SELECCIONAR ORDEN ===
    function clearOrderSelectionUI() {
      document.querySelectorAll(".order-card").forEach(el => el.classList.remove("selected"));
    }

    function selectOrder(orderId, orderData) {
      clearOrderSelectionUI();
      const card = document.querySelector(`.order-card[data-id="${orderId}"]`);
      if (card) card.classList.add("selected");

      currentOrderId = orderId;

      noOrderSelectedEl.style.display = "none";
      orderDetailEl.style.display = "block";

      detailTableEl.textContent = orderData.tableNumber || "?";
      detailCustomerEl.textContent = orderData.customerName || "Sin nombre";
      detailSourceEl.textContent = orderData.source || "desconocido";

      detailStatusEl.className = getStatusBadgeClass(orderData.status || "abierta");
      detailStatusEl.textContent = orderData.status || "abierta";

      const created = orderData.createdAt?.toDate ? orderData.createdAt.toDate() : null;
      detailCreatedAtEl.textContent = created
        ? created.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        : "--:--";

      detailTotalEl.textContent = formatCurrency(orderData.total ?? orderData.subtotal ?? 0);

      listenOrderItems(orderId);
      listenOrderMessages(orderId);

      // enlazar botones de estado
      const buttons = orderDetailEl.querySelectorAll("button[data-status]");
      buttons.forEach(btn => {
        btn.onclick = () => updateOrderStatus(orderId, btn.dataset.status);
      });
    }

    // === ESCUCHAR ITEMS DE ORDEN ===
    function listenOrderItems(orderId) {
      if (unsubscribeItems) unsubscribeItems();

      const itemsRef = collection(db, "branches", BRANCH_ID, "orders", orderId, "items");
      const qItems = query(itemsRef, orderBy("createdAt", "asc"));

      unsubscribeItems = onSnapshot(qItems, (snap) => {
        detailItemsEl.innerHTML = "";
        if (snap.empty) {
          detailItemsEl.innerHTML = "<p class='small'>No hay productos en esta orden.</p>";
          return;
        }

        let total = 0;

        snap.forEach(docSnap => {
          const d = docSnap.data();
          const amount = (d.unitPrice || 0) * (d.qty || 1);
          total += amount;

          const row = document.createElement("div");
          row.className = "detail-item-row";

          row.innerHTML = `
            <div>${d.qty || 1} × <strong>${d.productName || "Producto"}</strong> – ${formatCurrency(amount)}</div>
            ${d.notes ? `<div class="detail-item-row-notes">Nota: ${d.notes}</div>` : ""}
          `;

          detailItemsEl.appendChild(row);
        });

        detailTotalEl.textContent = formatCurrency(total);
      }, (err) => {
        console.error("Error items:", err);
      });
    }

    // === ESCUCHAR MENSAJES (CHAT) ===
    function listenOrderMessages(orderId) {
      if (unsubscribeMessages) unsubscribeMessages();

      const msgsRef = collection(db, "branches", BRANCH_ID, "orders", orderId, "messages");
      const qMsgs = query(msgsRef, orderBy("createdAt", "asc"));

      unsubscribeMessages = onSnapshot(qMsgs, (snap) => {
        chatAreaEl.innerHTML = "";

        if (snap.empty) {
          chatAreaEl.innerHTML = "<p class='small'>No hay mensajes aún.</p>";
          return;
        }

        snap.forEach(docSnap => {
          const m = docSnap.data();
          const sender = m.sender || "desconocido";
          const text = m.text || "";
          const created = m.createdAt?.toDate ? m.createdAt.toDate() : null;
          const timeStr = created
            ? created.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
            : "";

          const div = document.createElement("div");
          div.className = "chat-msg " + (sender === "cliente" ? "chat-msg-cliente" : "chat-msg-mesero");
          div.innerHTML = `
            <div>${text}</div>
            <div class="chat-meta">${sender} ${timeStr}</div>
          `;
          chatAreaEl.appendChild(div);
        });

        chatAreaEl.scrollTop = chatAreaEl.scrollHeight;
      }, (err) => {
        console.error("Error msgs:", err);
      });
    }

    // === ACTUALIZAR ESTADO DE ORDEN ===
    async function updateOrderStatus(orderId, newStatus) {
      try {
        await updateDoc(doc(db, "branches", BRANCH_ID, "orders", orderId), {
          status: newStatus,
          updatedAt: serverTimestamp()
        });
        setGlobalStatus("Orden " + orderId + " → " + newStatus);
      } catch (err) {
        console.error(err);
        setGlobalStatus("Error actualizando estado de orden.");
      }
    }

    // === ENVIAR MENSAJE AL CLIENTE ===
    chatSendBtn.onclick = async () => {
      if (!currentOrderId) {
        alert("Primero selecciona una orden.");
        return;
      }
      const text = chatInputEl.value.trim();
      if (!text) return;

      try {
        const msgsRef = collection(
          db,
          "branches",
          BRANCH_ID,
          "orders",
          currentOrderId,
          "messages"
        );
        await addDoc(msgsRef, {
          sender: "mesero",
          text,
          createdAt: serverTimestamp()
        });
        chatInputEl.value = "";
      } catch (err) {
        console.error(err);
        alert("No se pudo enviar el mensaje.");
      }
    };
  </script>
</body>
</html>