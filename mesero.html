<!DOCTYPE html>
<html lang="es">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ✅ Permitir leer el menú a cualquiera (productos)
    match /branches/{branchId}/products/{productId} {
      allow read: if true;
    }

    // ✅ Permitir leer/escribir órdenes e ítems (mesero + KDS)
    match /branches/{branchId}/orders/{orderId} {
      allow read, write: if true;

      match /items/{itemId} {
        allow read, write: if true;
      }
    }

    // (Opcional) Resto bloqueado por defecto:
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

  
  
  
  <head>
  <meta charset="UTF-8" />
  <title>Mesero POS – Cafecaro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #101010;
      color: #f5f5f5;
    }
    header {
      padding: 12px 16px;
      background: #181818;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header .branch {
      font-size: 13px;
      opacity: 0.8;
    }
    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: #181818;
      border-radius: 12px;
      border: 1px solid #333;
      padding: 12px;
      min-height: 200px;
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .mesa-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    input, select, button, textarea {
      border-radius: 6px;
      border: none;
      font-size: 14px;
      padding: 6px 10px;
      font-family: inherit;
    }
    input, select, textarea {
      background: #222;
      color: #f5f5f5;
    }
    button {
      background: #00c853;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }
    button.secondary {
      background: #333;
      color: #eee;
    }
    button.danger {
      background: #d32f2f;
      color: #fff;
    }
    button:disabled {
      background: #555;
      color: #aaa;
      cursor: not-allowed;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #222;
      font-size: 12px;
    }
    .flex {
      display: flex;
      align-items: center;
    }
    .flex-space {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .cat-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #202020;
      font-size: 13px;
      cursor: pointer;
    }
    .cat-btn.active {
      background: #00c853;
      color: #000;
      border-color: #00c853;
      font-weight: 600;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 4px;
    }
    .product-card {
      background: #202020;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }
    .product-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      border-color: #00c853;
    }
    .product-name {
      font-size: 14px;
      font-weight: 600;
    }
    .product-cat {
      font-size: 11px;
      opacity: 0.7;
    }
    .product-price {
      font-size: 13px;
      color: #c8ffb3;
      font-weight: 600;
    }
    .cart-list {
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
      border-top: 1px solid #333;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px dashed #333;
      gap: 8px;
    }
    .cart-title {
      font-size: 14px;
      font-weight: 500;
    }
    .cart-qty {
      font-size: 12px;
      opacity: 0.8;
    }
    .cart-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
    }
    .cart-actions button {
      padding: 2px 6px;
      font-size: 12px;
    }
    .cart-total {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      font-weight: 600;
    }
    .status {
      margin-top: 6px;
      font-size: 13px;
      opacity: 0.85;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Mesero POS – Cafecaro</h1>
      <div style="font-size:12px;opacity:0.8;">Levantar y enviar pedidos a cocina</div>
    </div>
    <div class="branch" id="branchLabel"></div>
  </header>

  <main>
    <!-- Panel izquierdo: menú -->
    <section class="panel">
      <h2>Menú</h2>

      <div class="mesa-controls">
        <label>
          Mesa:
          <input id="mesaInput" type="number" min="1" placeholder="Ej. 5" style="width:80px;" />
        </label>
        <button id="abrirMesaBtn" class="secondary">Abrir / usar mesa</button>
        <span id="mesaEstado" class="pill">Sin mesa seleccionada</span>
      </div>

      <div class="categories" id="categoriesContainer">
        <!-- Botones de categoría -->
      </div>

      <div class="products-grid" id="productsContainer">
        Cargando menú...
      </div>
    </section>

    <!-- Panel derecho: pedido actual -->
    <section class="panel">
      <div class="flex-space">
        <h2>Pedido actual</h2>
        <span id="orderInfo" class="pill">Sin orden</span>
      </div>

      <div class="cart-list" id="cartContainer">
        Añade productos tocando el menú de la izquierda.
      </div>

      <div class="cart-total">
        <span>Total:</span>
        <span id="cartTotal">$0.00</span>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="enviarPedidoBtn">Enviar pedido a Firestore</button>
        <button id="limpiarPedidoBtn" class="danger">Limpiar pedido local</button>
      </div>

      <div class="status" id="status"></div>
    </section>
  </main>

  <!-- Firebase web v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      addDoc,
      setDoc,
      writeBatch,
      serverTimestamp,
      query,
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // === Tu config de Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyDbxe3uCqt-VnhgFW8sd8uJZ5Wg8oQ0b6Y",
      authDomain: "cafecaro-af23b.firebaseapp.com",
      projectId: "cafecaro-af23b",
      storageBucket: "cafecaro-af23b.firebasestorage.app",
      messagingSenderId: "534231921780",
      appId: "1:534231921780:web:f3702e23c024c14c0c8d21",
      measurementId: "G-JC720XBF92"
    };

    const BRANCH_ID = "cafecaro-centro";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const branchLabel = document.getElementById("branchLabel");
    const categoriesContainer = document.getElementById("categoriesContainer");
    const productsContainer = document.getElementById("productsContainer");
    const mesaInput = document.getElementById("mesaInput");
    const abrirMesaBtn = document.getElementById("abrirMesaBtn");
    const mesaEstado = document.getElementById("mesaEstado");
    const cartContainer = document.getElementById("cartContainer");
    const cartTotalEl = document.getElementById("cartTotal");
    const enviarPedidoBtn = document.getElementById("enviarPedidoBtn");
    const limpiarPedidoBtn = document.getElementById("limpiarPedidoBtn");
    const statusEl = document.getElementById("status");
    const orderInfo = document.getElementById("orderInfo");

    branchLabel.textContent = `Sucursal: ${BRANCH_ID}`;

    let allProducts = [];
    let selectedCategory = null;
    let currentMesaNumber = null;
    let currentOrderId = null; // si en el futuro quieres reabrir orden
    let cart = []; // { productId, name, price, qty }

    // === Utilidades ===
    function formatCurrency(n) {
      return `$${n.toFixed(2)}`;
    }

    function renderCategories() {
      const cats = [...new Set(allProducts.map(p => p.category))].sort();
      categoriesContainer.innerHTML = "";

      const allBtn = document.createElement("button");
      allBtn.textContent = "Todo";
      allBtn.className = "cat-btn" + (selectedCategory === null ? " active" : "");
      allBtn.addEventListener("click", () => {
        selectedCategory = null;
        renderCategories();
        renderProducts();
      });
      categoriesContainer.appendChild(allBtn);

      cats.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.className = "cat-btn" + (selectedCategory === cat ? " active" : "");
        btn.addEventListener("click", () => {
          selectedCategory = cat;
          renderCategories();
          renderProducts();
        });
        categoriesContainer.appendChild(btn);
      });
    }

    function renderProducts() {
      productsContainer.innerHTML = "";

      if (allProducts.length === 0) {
        productsContainer.textContent = "No hay productos en el menú.";
        return;
      }

      const filtered = selectedCategory
        ? allProducts.filter(p => p.category === selectedCategory)
        : allProducts;

      if (filtered.length === 0) {
        productsContainer.textContent = "No hay productos para esta categoría.";
        return;
      }

      filtered.forEach(prod => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.addEventListener("click", () => {
          addToCart(prod);
        });

        card.innerHTML = `
          <div class="product-name">${prod.name}</div>
          <div class="product-cat">${prod.category}</div>
          <div class="product-price">${formatCurrency(prod.basePrice || 0)}</div>
        `;

        productsContainer.appendChild(card);
      });
    }

    function addToCart(product) {
      const idx = cart.findIndex(item => item.productId === product.id);
      if (idx >= 0) {
        cart[idx].qty += 1;
      } else {
        cart.push({
          productId: product.id,
          name: product.name,
          price: product.basePrice || 0,
          qty: 1
        });
      }
      renderCart();
    }

    function renderCart() {
      cartContainer.innerHTML = "";

      if (cart.length === 0) {
        cartContainer.textContent = "Añade productos tocando el menú de la izquierda.";
        cartTotalEl.textContent = "$0.00";
        return;
      }

      let total = 0;

      cart.forEach((item, index) => {
        total += item.price * item.qty;

        const row = document.createElement("div");
        row.className = "cart-item";

        row.innerHTML = `
          <div>
            <div class="cart-title">${item.name}</div>
            <div class="cart-qty">x${item.qty} · ${formatCurrency(item.price)}</div>
          </div>
          <div class="cart-actions">
            <button data-action="minus">-</button>
            <button data-action="plus">+</button>
            <button data-action="remove">×</button>
          </div>
        `;

        const actions = row.querySelector(".cart-actions");
        actions.addEventListener("click", (e) => {
          const action = e.target.getAttribute("data-action");
          if (!action) return;

          if (action === "minus") {
            if (cart[index].qty > 1) {
              cart[index].qty -= 1;
            } else {
              cart.splice(index, 1);
            }
          } else if (action === "plus") {
            cart[index].qty += 1;
          } else if (action === "remove") {
            cart.splice(index, 1);
          }
          renderCart();
        });

        cartContainer.appendChild(row);
      });

      cartTotalEl.textContent = formatCurrency(total);
    }

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    // === Cargar menú desde Firestore ===
    async function loadMenu() {
      setStatus("Cargando menú desde Firestore...");
      try {
        const productsRef = collection(db, "branches", BRANCH_ID, "products");
        const snap = await getDocs(productsRef);
        allProducts = [];
        snap.forEach(docSnap => {
          const data = docSnap.data();
          allProducts.push({
            id: docSnap.id,
            ...data
          });
        });

        if (allProducts.length === 0) {
          setStatus("No se encontraron productos en branches/" + BRANCH_ID + "/products.");
        } else {
          setStatus("Menú cargado. Productos: " + allProducts.length);
        }

        renderCategories();
        renderProducts();
      } catch (err) {
        console.error(err);
        setStatus("Error cargando menú: " + err.message);
      }
    }

    // === Abrir/usar mesa ===
    async function abrirMesa() {
      const mesaNum = parseInt(mesaInput.value, 10);
      if (!mesaNum || mesaNum <= 0) {
        alert("Escribe un número de mesa válido.");
        return;
      }

      currentMesaNumber = mesaNum;
      mesaEstado.textContent = `Mesa ${mesaNum} seleccionada`;
      mesaEstado.style.background = "#263238";

      // Opcional: podrías buscar si hay una orden abierta para esa mesa
      try {
        const ordersRef = collection(db, "branches", BRANCH_ID, "orders");
        const q = query(
          ordersRef,
          where("tableNumber", "==", mesaNum),
          where("status", "in", ["abierta", "en_preparacion"]),
          limit(1)
        );
        const snap = await getDocs(q);
        if (!snap.empty) {
          const docSnap = snap.docs[0];
          currentOrderId = docSnap.id;
          orderInfo.textContent = `Orden activa: ${currentOrderId}`;
          setStatus(`Mesa ${mesaNum} ya tiene una orden abierta (${currentOrderId}). Los productos nuevos se sumarán.`);
        } else {
          currentOrderId = null;
          orderInfo.textContent = "Sin orden (se creará nueva al enviar)";
          setStatus(`Mesa ${mesaNum} lista. Al enviar el pedido se creará una nueva orden.`);
        }
      } catch (err) {
        console.error(err);
        setStatus("Error buscando orden abierta: " + err.message);
      }
    }

    // === Enviar pedido a Firestore ===
    async function enviarPedido() {
      if (!currentMesaNumber) {
        alert("Selecciona primero una mesa.");
        return;
      }
      if (cart.length === 0) {
        alert("El pedido está vacío.");
        return;
      }

      enviarPedidoBtn.disabled = true;
      enviarPedidoBtn.textContent = "Enviando...";
      setStatus("Enviando pedido a Firestore...");

      try {
        const branchRef = doc(collection(db, "branches"), BRANCH_ID);
        const ordersRef = collection(branchRef, "orders");

        let orderRefDoc;
        let isNewOrder = false;

        if (currentOrderId) {
          // Usar orden existente
          orderRefDoc = doc(ordersRef, currentOrderId);
        } else {
          // Crear nueva orden
          orderRefDoc = await addDoc(ordersRef, {
            tableNumber: currentMesaNumber,
            tableId: null,
            status: "abierta",
            source: "mesero",
            subtotal: 0,
            tax: 0,
            discount: 0,
            total: 0,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          currentOrderId = orderRefDoc.id;
          isNewOrder = true;
        }

        // Crear items
        const batch = writeBatch(db);
        let subtotal = 0;

        const itemsCol = collection(orderRefDoc, "items");
        cart.forEach(item => {
          const lineTotal = item.price * item.qty;
          subtotal += lineTotal;
          const itemDoc = doc(itemsCol);
          batch.set(itemDoc, {
            productId: item.productId,
            productName: item.name,
            qty: item.qty,
            basePrice: item.price,
            unitPrice: item.price,
            totalPrice: lineTotal,
            status: "pendiente",
            notes: null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        });

        const tax = 0;
        const discount = 0;
        const total = subtotal;

        batch.set(orderRefDoc, {
          subtotal,
          tax,
          discount,
          total,
          updatedAt: serverTimestamp()
        }, { merge: true });

        await batch.commit();

        orderInfo.textContent = `Orden activa: ${currentOrderId}`;
        setStatus(`✅ Pedido enviado. ${isNewOrder ? "Se creó una nueva orden." : "Se agregaron productos a la orden existente."}`);

        // Opcional: limpiar carrito local
        cart = [];
        renderCart();
      } catch (err) {
        console.error(err);
        setStatus("❌ Error enviando pedido: " + err.message);
      } finally {
        enviarPedidoBtn.disabled = false;
        enviarPedidoBtn.textContent = "Enviar pedido a Firestore";
      }
    }

    function limpiarPedido() {
      cart = [];
      renderCart();
      setStatus("Pedido local limpiado (no afecta Firestore).");
    }

    // Eventos
    abrirMesaBtn.addEventListener("click", abrirMesa);
    enviarPedidoBtn.addEventListener("click", enviarPedido);
    limpiarPedidoBtn.addEventListener("click", limpiarPedido);

    // Cargar menú al iniciar
    loadMenu();
  </script>
</body>
</html>
