<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cafecaro – Caja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    header .sub {
      font-size: 11px;
      opacity: 0.7;
    }

    header .right {
      text-align: right;
      font-size: 12px;
    }

    .role-pill {
      display: inline-block;
      margin-top: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e3f2fd;
      color: #0d47a1;
    }

    #logoutBtn {
      margin-top: 4px;
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      background: #eeeeee;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 8px;
      gap: 8px;
    }

    @media (min-width: 900px) {
      main {
        flex-direction: row;
      }
    }

    .panel {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 10px;
    }

    @media (min-width: 900px) {
      .panel-left {
        flex: 0.9;
        margin-right: 6px;
      }
      .panel-right {
        flex: 1.1;
        margin-left: 6px;
      }
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .small {
      font-size: 11px;
      opacity: 0.7;
    }

    /* Filtros / resumen */
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
      font-size: 12px;
    }
    .chip.active {
      border-color: #2962ff;
      background: #e3f2fd;
      color: #0d47a1;
      font-weight: 600;
    }

    .stats-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      margin-bottom: 8px;
    }

    @media (min-width: 900px) {
      .stats-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .stat-card {
      border-radius: 10px;
      border: 1px solid #eee;
      padding: 8px;
      font-size: 12px;
      background: #fafafa;
    }
    .stat-label {
      opacity: 0.7;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 600;
    }

    /* Lista de órdenes */
    .orders-list {
      max-height: 60vh;
      overflow-y: auto;
      margin-top: 4px;
    }

    .order-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 4px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      font-size: 12px;
    }
    .order-row:nth-child(2n) {
      background: #fafafa;
    }
    .order-row.selected {
      background: #e3f2fd;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-right: 4px;
    }
    .badge-status-abierta { background: #e3f2fd; color: #0d47a1; }
    .badge-status-en_preparacion { background: #fff3e0; color: #e65100; }
    .badge-status-lista { background: #e8f5e9; color: #1b5e20; }
    .badge-status-cerrada { background: #eeeeee; color: #424242; }
    .badge-paid { background: #c8e6c9; color: #1b5e20; }
    .badge-unpaid { background: #ffebee; color: #b71c1c; }

    /* Detalle de orden */
    .detail-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .detail-items {
      max-height: 35vh;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .detail-item-row {
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .detail-item-row:last-child {
      border-bottom: none;
    }
    .detail-item-notes {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 2px;
    }

    .detail-footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
      font-size: 12px;
      align-items: center;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .btn-small {
      padding: 4px 10px;
      font-size: 11px;
    }
    .btn-primary { background: #2962ff; color: #fff; }
    .btn-success { background: #00c853; color: #000; }
    .btn-warning { background: #ffb300; color: #000; }
    .btn-neutral { background: #eeeeee; color: #333; }
    .btn-danger { background: #ef5350; color: #fff; }

    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
    }

    .status-bar {
      padding: 6px 12px;
      font-size: 12px;
      border-top: 1px solid #ddd;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Caja</h1>
      <div class="sub" id="branchLabel">Sucursal: —</div>
    </div>
    <div class="right">
      <div id="currentUserEmail">—</div>
      <div id="currentUserRole" class="role-pill">Verificando rol...</div>
      <button id="logoutBtn">Salir</button>
    </div>
  </header>

  <main>
    <!-- Panel izquierdo: filtros + resumen + lista -->
    <section class="panel panel-left">
      <h2>Resumen de ventas</h2>
      <p class="small">Filtra por fecha y revisa los movimientos de caja.</p>

      <div class="filters-row">
        <span class="small">Rango:</span>
        <div id="chipHoy" class="chip active">Hoy</div>
        <div id="chipTodos" class="chip">Todos</div>
        <span class="small" id="todayLabel"></span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Órdenes</div>
          <div id="statOrders" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total vendido</div>
          <div id="statTotal" class="stat-value">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pagadas</div>
          <div id="statPaid" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pendientes</div>
          <div id="statUnpaid" class="stat-value">0</div>
        </div>
      </div>

      <div class="orders-list" id="ordersList"></div>
    </section>

    <!-- Panel derecho: detalle de orden -->
    <section class="panel panel-right">
      <h2>Detalle de orden</h2>
      <p class="small" id="noOrderSelected">Selecciona una orden para ver sus detalles.</p>

      <div id="detailPanel" style="display:none;">
        <div class="detail-header">
          <div>
            <div><strong>Orden <span id="detailOrderIdShort"></span></strong></div>
            <div>Mesa <span id="detailTable"></span> — <span id="detailCustomer"></span></div>
            <div class="small">Fuente: <span id="detailSource"></span></div>
          </div>
          <div style="text-align:right;">
            <div class="small">Estado:</div>
            <div id="detailStatusBadge" class="badge"></div>
            <div class="small">Pago: <span id="detailPaidBadge" class="badge"></span></div>
            <div class="small">Creada: <span id="detailCreatedAt"></span></div>
          </div>
        </div>

        <div class="detail-items" id="detailItems"></div>

        <div class="detail-footer">
          <div>
            <div>Total orden: <strong id="detailTotal">$0.00</strong></div>
            <div class="small">Método de pago: <span id="detailPaymentMethod">—</span></div>
          </div>
          <div id="detailButtons" style="display:flex;flex-wrap:wrap;gap:4px;">
            <!-- botones se llenan por JS según rol -->
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="globalStatus" class="status-bar">Conectando...</div>

  <!-- ============================= -->
  <!--     FIREBASE + LÓGICA        -->
  <!-- ============================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      orderBy,
      onSnapshot,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // === CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyDbxe3uCqt-VnhgFW8sd8uJZ5Wg8oQ0b6Y",
      authDomain: "cafecaro-af23b.firebaseapp.com",
      projectId: "cafecaro-af23b",
      storageBucket: "cafecaro-af23b.firebasestorage.app",
      messagingSenderId: "534231921780",
      appId: "1:534231921780:web:f3702e23c024c14c0c8d21"
    };

    const BRANCH_ID = "cafecaro-centro";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const branchLabel = document.getElementById("branchLabel");
    const currentUserEmailEl = document.getElementById("currentUserEmail");
    const currentUserRoleEl = document.getElementById("currentUserRole");
    const logoutBtn = document.getElementById("logoutBtn");
    const globalStatus = document.getElementById("globalStatus");

    const chipHoy = document.getElementById("chipHoy");
    const chipTodos = document.getElementById("chipTodos");
    const todayLabel = document.getElementById("todayLabel");

    const statOrders = document.getElementById("statOrders");
    const statTotal = document.getElementById("statTotal");
    const statPaid = document.getElementById("statPaid");
    const statUnpaid = document.getElementById("statUnpaid");

    const ordersListEl = document.getElementById("ordersList");

    const noOrderSelectedEl = document.getElementById("noOrderSelected");
    const detailPanelEl = document.getElementById("detailPanel");

    const detailOrderIdShortEl = document.getElementById("detailOrderIdShort");
    const detailTableEl = document.getElementById("detailTable");
    const detailCustomerEl = document.getElementById("detailCustomer");
    const detailSourceEl = document.getElementById("detailSource");
    const detailStatusBadgeEl = document.getElementById("detailStatusBadge");
    const detailPaidBadgeEl = document.getElementById("detailPaidBadge");
    const detailCreatedAtEl = document.getElementById("detailCreatedAt");
    const detailItemsEl = document.getElementById("detailItems");
    const detailTotalEl = document.getElementById("detailTotal");
    const detailPaymentMethodEl = document.getElementById("detailPaymentMethod");
    const detailButtonsEl = document.getElementById("detailButtons");

    branchLabel.textContent = "Sucursal: " + BRANCH_ID;

    let isAdmin = false;
    let isCaja = false;
    let allOrders = []; // array con {id, data}
    let currentFilter = "hoy"; // "hoy" | "todos"
    let currentOrderId = null;

    // Fecha de hoy (para etiqueta)
    const today = new Date();
    todayLabel.textContent = today.toLocaleDateString("es-MX", {
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "numeric"
    });

    function setGlobalStatus(msg) {
      globalStatus.textContent = msg;
    }

    // === AUTH + ROL ===
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUserEmailEl.textContent = user.email || "(sin correo)";

      try {
        const userDocRef = doc(db, "users", user.uid);
        const snap = await getDoc(userDocRef);

        if (!snap.exists()) {
          currentUserRoleEl.textContent = "Sin rol";
          setGlobalStatus("Tu usuario no tiene rol asignado.");
          alert("Tu usuario no tiene rol asignado. Contacta al administrador.");
          return;
        }

        const data = snap.data();
        const role = data.role || "sin_rol";

        isAdmin = role === "admin";
        isCaja = role === "caja";

        if (!(isAdmin || isCaja)) {
          alert("Acceso restringido. Esta página es solo para rol 'admin' o 'caja'.");
          window.location.href = "login.html";
          return;
        }

        currentUserRoleEl.textContent = "Rol: " + role;
        setGlobalStatus("Conectado como " + role + ".");
        listenOrders();
      } catch (err) {
        console.error(err);
        setGlobalStatus("Error al verificar tu rol.");
      }
    });

    logoutBtn.onclick = async () => {
      await signOut(auth);
      window.location.href = "login.html";
    };

    // === ESCUCHAR ÓRDENES ===
    function listenOrders() {
      const ordersRef = collection(db, "branches", BRANCH_ID, "orders");
      const qOrders = query(ordersRef, orderBy("createdAt", "desc"));

      onSnapshot(qOrders, (snap) => {
        allOrders = [];
        snap.forEach(docSnap => {
          const data = docSnap.data();
          allOrders.push({ id: docSnap.id, data });
        });

        renderOrders();
      }, (err) => {
        console.error("Error leyendo órdenes en caja:", err);
        setGlobalStatus("Error leyendo órdenes.");
      });
    }

    // === FILTROS ===
    chipHoy.onclick = () => {
      currentFilter = "hoy";
      chipHoy.classList.add("active");
      chipTodos.classList.remove("active");
      renderOrders();
    };

    chipTodos.onclick = () => {
      currentFilter = "todos";
      chipTodos.classList.add("active");
      chipHoy.classList.remove("active");
      renderOrders();
    };

    function orderMatchesFilter(order) {
      if (currentFilter === "todos") return true;

      const created = order.data.createdAt?.toDate
        ? order.data.createdAt.toDate()
        : null;
      if (!created) return false;

      const d = new Date(created);
      return (
        d.getFullYear() === today.getFullYear() &&
        d.getMonth() === today.getMonth() &&
        d.getDate() === today.getDate()
      );
    }

    function formatCurrency(n) {
      return "$" + (n || 0).toFixed(2);
    }

    function formatTime(date) {
      if (!date) return "--:--";
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case "abierta": return "badge badge-status-abierta";
        case "en_preparacion": return "badge badge-status-en_preparacion";
        case "lista": return "badge badge-status-lista";
        case "cerrada": return "badge badge-status-cerrada";
        default: return "badge";
      }
    }

    function getPaidBadgeText(orderData) {
      return orderData.paid ? "Pagada" : "Pendiente";
    }

    function getPaidBadgeClass(orderData) {
      return orderData.paid ? "badge badge-paid" : "badge badge-unpaid";
    }

    // === RENDER ORDENES + STATS ===
    function renderOrders() {
      ordersListEl.innerHTML = "";
      let filtered = allOrders.filter(orderMatchesFilter);

      if (!filtered.length) {
        ordersListEl.innerHTML = "<p class='small' style='padding:6px;'>No hay órdenes para este rango.</p>";
      }

      let total = 0;
      let paidCount = 0;
      let unpaidCount = 0;

      filtered.forEach(({ id, data }) => {
        const status = data.status || "abierta";
        const totalOrder = data.total ?? data.subtotal ?? 0;
        const created = data.createdAt?.toDate ? data.createdAt.toDate() : null;

        total += totalOrder;
        if (data.paid) paidCount++; else unpaidCount++;

        const row = document.createElement("div");
        row.className = "order-row";
        row.dataset.id = id;

        row.innerHTML = `
          <div>
            <div><strong>Mesa ${data.tableNumber || "?"}</strong> – ${data.customerName || "Sin nombre"}</div>
            <div class="small">
              <span class="${getStatusBadgeClass(status)}">${status}</span>
              <span class="${getPaidBadgeClass(data)}">${getPaidBadgeText(data)}</span>
            </div>
          </div>
          <div style="text-align:right;">
            <div>${formatCurrency(totalOrder)}</div>
            <div class="small">${formatTime(created)}</div>
          </div>
        `;

        row.addEventListener("click", () => selectOrder(id, data));
        ordersListEl.appendChild(row);
      });

      statOrders.textContent = filtered.length;
      statTotal.textContent = formatCurrency(total);
      statPaid.textContent = paidCount;
      statUnpaid.textContent = unpaidCount;

      // Si la orden seleccionada ya no pasa filtro, limpiar detalle
      if (currentOrderId) {
        const stillExists = filtered.some(o => o.id === currentOrderId);
        if (!stillExists) {
          currentOrderId = null;
          detailPanelEl.style.display = "none";
          noOrderSelectedEl.style.display = "block";
          document.querySelectorAll(".order-row").forEach(r => r.classList.remove("selected"));
        } else {
          // volver a marcar selección visual
          document.querySelectorAll(".order-row").forEach(r => {
            r.classList.toggle("selected", r.dataset.id === currentOrderId);
          });
        }
      }
    }

    // === SELECCIONAR ORDEN ===
    async function selectOrder(orderId, orderData) {
      currentOrderId = orderId;
      document.querySelectorAll(".order-row").forEach(r => {
        r.classList.toggle("selected", r.dataset.id === orderId);
      });

      noOrderSelectedEl.style.display = "none";
      detailPanelEl.style.display = "block";

      detailOrderIdShortEl.textContent = orderId.slice(-6);
      detailTableEl.textContent = orderData.tableNumber || "?";
      detailCustomerEl.textContent = orderData.customerName || "Sin nombre";
      detailSourceEl.textContent = orderData.source || "desconocido";

      const status = orderData.status || "abierta";
      detailStatusBadgeEl.className = getStatusBadgeClass(status);
      detailStatusBadgeEl.textContent = status;

      detailPaidBadgeEl.className = getPaidBadgeClass(orderData);
      detailPaidBadgeEl.textContent = getPaidBadgeText(orderData);

      const created = orderData.createdAt?.toDate ? orderData.createdAt.toDate() : null;
      detailCreatedAtEl.textContent = formatTime(created);

      detailTotalEl.textContent = formatCurrency(orderData.total ?? orderData.subtotal ?? 0);
      detailPaymentMethodEl.textContent = orderData.paymentMethod || "—";

      // Cargar items
      await loadOrderItems(orderId);
      renderDetailButtons(orderId, orderData);
    }

    async function loadOrderItems(orderId) {
      detailItemsEl.innerHTML = "<p class='small'>Cargando productos...</p>";

      try {
        const itemsCol = collection(db, "branches", BRANCH_ID, "orders", orderId, "items");
        const qItems = query(itemsCol, orderBy("createdAt", "asc"));

        onSnapshot(qItems, (snap) => {
          detailItemsEl.innerHTML = "";
          if (snap.empty) {
            detailItemsEl.innerHTML = "<p class='small'>Esta orden no tiene productos.</p>";
            return;
          }

          snap.forEach(docSnap => {
            const d = docSnap.data();
            const amount = (d.unitPrice || 0) * (d.qty || 1);

            const row = document.createElement("div");
            row.className = "detail-item-row";
            row.innerHTML = `
              <div>${d.qty || 1} × <strong>${d.productName || "Producto"}</strong> – ${formatCurrency(amount)}</div>
              ${d.notes ? `<div class="detail-item-notes">Nota: ${d.notes}</div>` : ""}
            `;
            detailItemsEl.appendChild(row);
          });
        });
      } catch (err) {
        console.error("Error cargando items:", err);
        detailItemsEl.innerHTML = "<p class='small'>Error al cargar los productos.</p>";
      }
    }

    // === BOTONES DE DETALLE (según rol) ===
    function renderDetailButtons(orderId, orderData) {
      detailButtonsEl.innerHTML = "";

      const status = orderData.status || "abierta";
      const paid = !!orderData.paid;

      // Botones de estado solo para admin
      if (isAdmin) {
        const btnPreparacion = createButton("En preparación", "btn-small btn-warning", () =>
          changeStatus(orderId, "en_preparacion")
        );
        const btnLista = createButton("Lista", "btn-small btn-success", () =>
          changeStatus(orderId, "lista")
        );
        const btnCerrada = createButton("Cerrar", "btn-small btn-neutral", () =>
          changeStatus(orderId, "cerrada")
        );

        detailButtonsEl.appendChild(btnPreparacion);
        detailButtonsEl.appendChild(btnLista);
        detailButtonsEl.appendChild(btnCerrada);
      }

      // Botones de pago para admin y caja
      if (isAdmin || isCaja) {
        const btnPagoEfectivo = createButton("Marcar pagado (efectivo)", "btn-small btn-primary", () =>
          markPaid(orderId, "efectivo")
        );
        const btnPagoTarjeta = createButton("Marcar pagado (tarjeta)", "btn-small btn-primary", () =>
          markPaid(orderId, "tarjeta")
        );

        if (paid) {
          btnPagoEfectivo.disabled = true;
          btnPagoTarjeta.disabled = true;
        }

        detailButtonsEl.appendChild(btnPagoEfectivo);
        detailButtonsEl.appendChild(btnPagoTarjeta);
      }

      // Botón borrar orden solo admin (opcional, aquí solo la marcamos cerrada)
      /*
      if (isAdmin) {
        const btnEliminar = createButton("Eliminar orden", "btn-small btn-danger", () =>
          deleteOrder(orderId)
        );
        detailButtonsEl.appendChild(btnEliminar);
      }
      */
    }

    function createButton(label, className, onClick) {
      const btn = document.createElement("button");
      btn.className = "btn " + className;
      btn.textContent = label;
      btn.onclick = onClick;
      return btn;
    }

    async function changeStatus(orderId, newStatus) {
      try {
        await updateDoc(doc(db, "branches", BRANCH_ID, "orders", orderId), {
          status: newStatus,
          updatedAt: serverTimestamp()
        });
        setGlobalStatus(`Orden ${orderId.slice(-6)} → ${newStatus}`);
      } catch (err) {
        console.error("Error cambiando estado:", err);
        alert("No se pudo actualizar el estado de la orden.");
      }
    }

    async function markPaid(orderId, method) {
      try {
        await updateDoc(doc(db, "branches", BRANCH_ID, "orders", orderId), {
          paid: true,
          paymentMethod: method,
          paidAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        setGlobalStatus(`Orden ${orderId.slice(-6)} marcada pagada (${method}).`);
      } catch (err) {
        console.error("Error marcando pagada:", err);
        alert("No se pudo marcar la orden como pagada.");
      }
    }

    /*
    // Solo si en el futuro quisieras eliminar físicamente órdenes
    async function deleteOrder(orderId) {
      if (!confirm("¿Seguro que deseas eliminar esta orden? Esta acción no se puede deshacer.")) return;
      try {
        await deleteDoc(doc(db, "branches", BRANCH_ID, "orders", orderId));
        setGlobalStatus(`Orden ${orderId.slice(-6)} eliminada.`);
      } catch (err) {
        console.error("Error eliminando orden:", err);
        alert("No se pudo eliminar la orden.");
      }
    }
    */
  </script>
</body>
</html>
