<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Caja – Cafecaro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050505;
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 10px 16px;
      background: #111;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 18px; }
    header .sub { font-size: 12px; opacity: 0.8; }
    header .right { text-align: right; font-size: 12px; }

    .role-pill {
      padding: 4px 10px; border-radius: 999px; font-size: 11px; margin-top: 4px;
      display: inline-block;
    }
    .role-admin { background: #00c853; color: #000; }
    .role-caja { background: #2962ff; color: #fff; }

    .toolbar {
      padding: 8px 16px; background: #111; border-bottom: 1px solid #222;
      display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px;
    }

    select, input[type="date"] {
      background: #222; color: #f5f5f5; border: 1px solid #333; border-radius: 6px;
      padding: 4px 8px; font-size: 12px;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(220px, 300px) minmax(0, 1fr);
    }

    .panel-left {
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
    }

    .orders-list {
      padding: 8px; overflow-y: auto; flex: 1;
    }

    .order-row {
      background: #121212; border-radius: 10px; border: 1px solid #333;
      padding: 8px; margin-bottom: 6px; cursor: pointer; font-size: 12px;
    }
    .order-row.selected { border-color: #00c853; }

    .order-row-title { font-weight: 600; font-size: 13px; }
    .order-row-meta { font-size: 11px; opacity: 0.8; }

    .status-chip {
      padding: 2px 6px; border-radius: 999px; font-size: 10px; text-transform: uppercase;
    }
    .status-abierta { background: #ffab00; color: #000; }
    .status-en_preparacion { background: #2962ff; color: #fff; }
    .status-lista { background: #00c853; color: #000; }
    .status-cerrada { background: #757575; color: #fff; }

    .panel-right { padding: 10px 12px; display: flex; flex-direction: column; }

    .detail-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      border-bottom: 1px solid #222; padding-bottom: 8px; margin-bottom: 8px;
    }

    .detail-main-title { font-size: 16px; margin: 0; }
    .detail-sub { font-size: 12px; opacity: 0.85; }
    .detail-meta { font-size: 11px; opacity: 0.8; margin-top: 4px; }

    .items-table {
      margin-top: 6px; border-radius: 10px; border: 1px solid #222; overflow: hidden;
    }

    .items-header {
      background: #151515; padding: 6px 8px; font-weight: 600;
      display: grid; grid-template-columns: 2.5fr 0.8fr 0.9fr 1.1fr;
    }

    .items-row {
      padding: 6px 8px;
      display: grid;
      grid-template-columns: 2.5fr 0.8fr 0.9fr 1.1fr;
      align-items: center;
    }

    .items-row:nth-child(odd) { background: #111; }
    .items-row:nth-child(even) { background: #161616; }

    .items-row-qty input {
      width: 50px; text-align: center; background: #222; border: 1px solid #333;
      border-radius: 6px; color: #f5f5f5;
    }

    .items-row-status {
      font-size: 11px; padding: 2px 6px; border-radius: 999px; text-align: center;
    }

    .items-row-notes {
      font-size: 11px; opacity: 0.8;
    }

    .totals-card {
      margin-top: 8px; padding: 8px; border-radius: 10px; background: #101010;
      border: 1px solid #333; display: grid; grid-template-columns: 1.2fr 1fr;
    }

    .actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-primary { background: #00c853; color: #000; }
    .btn-danger { background: #b71c1c; color: #fff; }
    .btn-secondary { background: #333; color: #eee; }

    .chat-card {
      margin-top: 10px; padding: 8px; border-radius: 10px; background: #101010;
      border: 1px solid #333; display: flex; flex-direction: column; gap: 6px;
    }

    .chat-messages {
      max-height: 180px; overflow-y: auto; background: #151515;
      padding: 8px; border-radius: 8px; display: flex; flex-direction: column; gap: 6px;
    }

    .msg { padding: 6px 8px; border-radius: 10px; max-width: 80%; font-size: 12px; }
    .msg-cliente { background: #263238; align-self: flex-start; }
    .msg-mesero { background: #00c853; color: #000; align-self: flex-end; }

    .status-bar { padding: 6px 16px; background: #080808; font-size: 12px; }

  </style>
</head>
<body>
  <header>
    <div>
      <h1>Caja – Cafecaro</h1>
      <div class="sub">Control de ventas y comunicación</div>
    </div>
    <div class="right">
      <div id="branchLabel"></div>
      <div id="rolePill" class="role-pill role-caja">Modo caja (solo lectura)</div>
    </div>
  </header>

  <div class="toolbar">
    <div>Fecha: <input type="date" id="dateFilter" /></div>
    <div>
      Estado:
      <select id="statusFilter">
        <option value="todos">Todos</option>
        <option value="abierta">Abierta</option>
        <option value="en_preparacion">En preparación</option>
        <option value="lista">Lista</option>
        <option value="cerrada">Cerrada</option>
      </select>
    </div>
    <div style="opacity:0.6;">Entrar como admin: <code>?role=admin</code></div>
  </div>

  <main>
    <section class="panel-left">
      <div id="ordersList" class="orders-list"></div>
    </section>

    <section class="panel-right">
      <div id="detailContainer">
        <p class="empty-detail">Selecciona una orden para ver su detalle.</p>
      </div>
    </section>
  </main>

  <div id="statusText" class="status-bar">Cargando...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, doc, onSnapshot, query,
      orderBy, updateDoc, serverTimestamp, getDocs, addDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDbxe3uCqt-VnhgFW8sd8uJZ5Wg8oQ0b6Y",
      authDomain: "cafecaro-af23b.firebaseapp.com",
      projectId: "cafecaro-af23b",
      storageBucket: "cafecaro-af23b.firebasestorage.app",
      messagingSenderId: "534231921780",
      appId: "1:534231921780:web:f3702e23c024c14c0c8d21"
    };

    const BRANCH_ID = "cafecaro-centro";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const branchLabel = document.getElementById("branchLabel");
    branchLabel.textContent = `Sucursal: ${BRANCH_ID}`;

    const params = new URLSearchParams(window.location.search);
    const isAdmin = params.get("role") === "admin";

    const rolePill = document.getElementById("rolePill");
    if (isAdmin) {
      rolePill.textContent = "Modo administrador";
      rolePill.classList.remove("role-caja");
      rolePill.classList.add("role-admin");
    }

    const ordersList = document.getElementById("ordersList");
    const detailContainer = document.getElementById("detailContainer");
    const dateFilter = document.getElementById("dateFilter");
    const statusFilter = document.getElementById("statusFilter");
    const statusText = document.getElementById("statusText");

    function setStatus(msg) {
      statusText.textContent = msg;
    }

    function formatCurrency(n) {
      return `$${(n || 0).toFixed(2)}`;
    }

    function formatDateTime(ts) {
      if (!ts?.toDate) return "-";
      const d = ts.toDate();
      const p = (x)=> (x<10?"0"+x:x);
      return `${p(d.getDate())}/${p(d.getMonth()+1)} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }

    let currentOrderId = null;
    let currentOrders = new Map();
    let unsubscribeOrders = null;
    let unsubscribeMessages = null;

    (function setDefaultDate() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      dateFilter.value = `${yyyy}-${mm}-${dd}`;
    })();

    function listenOrders() {
      const ordersRef = collection(db, "branches", BRANCH_ID, "orders");
      const qOrders = query(ordersRef, orderBy("createdAt","desc"));

      unsubscribeOrders = onSnapshot(qOrders, snap => {
        currentOrders.clear();
        snap.forEach(docSnap => currentOrders.set(docSnap.id, docSnap.data()));
        renderOrdersList();
      }, err => console.error(err));
    }

    function matchesFilters(order) {
      const s = statusFilter.value;
      if (s !== "todos" && order.status !== s) return false;

      const dateVal = dateFilter.value;
      if (dateVal && order.createdAt?.toDate) {
        const d = order.createdAt.toDate();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}` === dateVal;
      }
      return true;
    }

    function renderOrdersList() {
      ordersList.innerHTML = "";

      const filtered = [...currentOrders.entries()].filter(([id,data]) => matchesFilters(data));

      if (filtered.length === 0) {
        ordersList.innerHTML = "<p style='opacity:0.8;font-size:12px;'>No hay órdenes.</p>";
        return;
      }

      filtered.forEach(([id,data]) => {
        const row = document.createElement("div");
        row.className = "order-row" + (id === currentOrderId ? " selected" : "");
        row.dataset.orderId = id;

        const mesa = data.tableNumber ?? "-";
        const name = data.customerName ? ` – ${data.customerName}` : "";
        const statusClass = `status-${data.status}`;

        row.innerHTML = `
          <div class="order-row-title">Mesa ${mesa}${name}</div>
          <div class="order-row-meta">
            #${id.substring(0,6)} · ${formatDateTime(data.createdAt)} · ${formatCurrency(data.total || data.subtotal || 0)}
          </div>
          <div class="status-chip ${statusClass}">${data.status}</div>
        `;

        row.onclick = () => {
          currentOrderId = id;
          renderOrdersList();
          loadOrderDetail(id, data);
        };

        ordersList.appendChild(row);
      });
    }

    dateFilter.onchange = renderOrdersList;
    statusFilter.onchange = renderOrdersList;

    async function loadOrderDetail(orderId, orderData) {
      detailContainer.innerHTML = `<p style="opacity:0.7;">Cargando detalle...</p>`;

      const itemsRef = collection(db, "branches", BRANCH_ID, "orders", orderId, "items");
      const snap = await getDocs(itemsRef);

      const items = [];
      snap.forEach(docSnap => items.push({ id: docSnap.id, ...docSnap.data() }));

      renderOrderDetail(orderId, orderData, items);
      listenMessages(orderId);
    }

    function renderOrderDetail(orderId, orderData, items) {
      detailContainer.innerHTML = "";

      const subtotal = orderData.subtotal || 0;
      const tax = orderData.tax || 0;
      const disc = orderData.discount || 0;
      const total = orderData.total != null ? orderData.total : subtotal + tax - disc;

      const wrapper = document.createElement("div");

      wrapper.innerHTML = `
        <div class="detail-header">
          <div>
            <h2 class="detail-main-title">
              Mesa ${orderData.tableNumber ?? "-"}${orderData.customerName ? " – " + orderData.customerName : ""}
            </h2>
            <div class="detail-sub">Pedido: <strong>${orderId}</strong></div>
            <div class="detail-meta">
              Creado: ${formatDateTime(orderData.createdAt)}<br>
              Actualizado: ${formatDateTime(orderData.updatedAt)}
            </div>
          </div>
          <div style="min-width:140px;">
            <div style="font-size:11px;opacity:0.8;">Estado</div>
            <select id="orderStatusSelect" ${!isAdmin ? "disabled" : ""}>
              <option value="abierta">abierta</option>
              <option value="en_preparacion">en_preparacion</option>
              <option value="lista">lista</option>
              <option value="cerrada">cerrada</option>
            </select>
          </div>
        </div>

        <div class="items-table">
          <div class="items-header">
            <div>Producto</div>
            <div>Cant.</div>
            <div>P. unit</div>
            <div>Total</div>
          </div>
          <div id="itemsBody"></div>
        </div>
      `;

      detailContainer.appendChild(wrapper);

      const itemsBody = wrapper.querySelector("#itemsBody");

      // AQUI INICIA EL BLOQUE DONDE SE INSERTA CADA ITEM
items.forEach(item => {
        const lineTotal = item.totalPrice ?? (item.unitPrice || 0) * (item.qty || 1);

        const row = document.createElement("div");
        row.className = "items-row";

        row.innerHTML = `
          <div>
            <div>${item.productName || "Producto"}</div>
            ${item.notes ? `<div class="items-row-notes">Nota: ${item.notes}</div>` : ""}
            <div class="items-row-status ${"status-" + (item.status || "pendiente")}">
              ${item.status || "pendiente"}
            </div>
          </div>
          <div class="items-row-qty">
            <input type="number" min="1" value="${item.qty || 1}" data-item-id="${item.id}" ${!isAdmin ? "disabled" : ""}>
          </div>
          <div>${formatCurrency(item.unitPrice || 0)}</div>
          <div>${formatCurrency(lineTotal)}</div>
        `;

        itemsBody.appendChild(row);
      });

      /* === Totales === */
      const totals = document.createElement("div");
      totals.className = "totals-card";
      totals.innerHTML = `
        <div>
          <div class="totals-row">
            <span>Subtotal</span>
            <input type="number" id="subtotalInput" step="0.01" value="${subtotal}" ${!isAdmin ? "disabled" : ""}>
          </div>
          <div class="totals-row">
            <span>Impuestos</span>
            <input type="number" id="taxInput" step="0.01" value="${tax}" ${!isAdmin ? "disabled" : ""}>
          </div>
          <div class="totals-row">
            <span>Descuento</span>
            <input type="number" id="discountInput" step="0.01" value="${disc}" ${!isAdmin ? "disabled" : ""}>
          </div>
        </div>
        <div class="totals-grand" id="totalDisplay">
          ${formatCurrency(total)}
        </div>
      `;
      detailContainer.appendChild(totals);

      const subtotalInput = totals.querySelector("#subtotalInput");
      const taxInput = totals.querySelector("#taxInput");
      const discountInput = totals.querySelector("#discountInput");
      const totalDisplay = totals.querySelector("#totalDisplay");

      function updateTotal() {
        const sub = parseFloat(subtotalInput.value)||0;
        const tax = parseFloat(taxInput.value)||0;
        const dis = parseFloat(discountInput.value)||0;
        totalDisplay.textContent = formatCurrency(sub+tax-dis);
      }

      if (isAdmin) {
        subtotalInput.oninput = updateTotal;
        taxInput.oninput = updateTotal;
        discountInput.oninput = updateTotal;
      }

      /* === ACCIONES === */
      const actions = document.createElement("div");
      actions.className = "actions";

      if (isAdmin) {
        actions.innerHTML = `
          <button class="btn-primary" id="saveTotalsBtn">Guardar totales</button>
          <button class="btn-secondary" id="recalcBtn">Recalcular</button>
          <button class="btn-danger" id="closeOrderBtn">Cerrar orden</button>
        `;
      } else {
        actions.innerHTML = `<span style="font-size:12px;opacity:0.8;">Modo caja: no editable</span>`;
      }

      detailContainer.appendChild(actions);

      const statusSelect = wrapper.querySelector("#orderStatusSelect");
      if (statusSelect) statusSelect.value = orderData.status;

      if (isAdmin) {
        document.getElementById("saveTotalsBtn").onclick = async () => {
          const sub = parseFloat(subtotalInput.value)||0;
          const tax = parseFloat(taxInput.value)||0;
          const dis = parseFloat(discountInput.value)||0;

          const orderRef = doc(db,"branches",BRANCH_ID,"orders",orderId);
          await updateDoc(orderRef,{
            subtotal:sub, tax:tax, discount:dis,
            total: sub+tax-dis,
            status: statusSelect.value,
            updatedAt: serverTimestamp()
          });
          setStatus("Totales guardados.");
        };

        document.getElementById("recalcBtn").onclick = () => {
          let newSub = 0;
          items.forEach(it=>{
            const line = it.totalPrice ?? (it.unitPrice||0)*(it.qty||1);
            newSub += line;
          });
          subtotalInput.value = newSub;
          updateTotal();
        };

        document.getElementById("closeOrderBtn").onclick = async () => {
          if (!confirm("¿Cerrar orden?")) return;

          const sub = parseFloat(subtotalInput.value)||0;
          const tax = parseFloat(taxInput.value)||0;
          const dis = parseFloat(discountInput.value)||0;

          const orderRef = doc(db,"branches",BRANCH_ID,"orders",orderId);
          await updateDoc(orderRef,{
            status:"cerrada",
            subtotal:sub, tax:tax, discount:dis,
            total:sub+tax-dis,
            updatedAt:serverTimestamp()
          });
          setStatus("Orden cerrada.");
        };

        statusSelect.onchange = async () => {
          const orderRef = doc(db,"branches",BRANCH_ID,"orders",orderId);
          await updateDoc(orderRef,{
            status: statusSelect.value,
            updatedAt: serverTimestamp()
          });
        };
      }

      /* ==== CHAT ==== */
      const chatCard = document.createElement("div");
      chatCard.className = "chat-card";
      chatCard.innerHTML = `
        <div class="chat-title">Chat con el cliente</div>
        <div id="messagesList" class="chat-messages"></div>
        <div class="chat-input-row">
          <textarea id="messageInput" placeholder="Mensaje..." ${!isAdmin ? "disabled" : ""}></textarea>
          <button id="sendMessageBtn" class="btn-primary" ${!isAdmin ? "disabled" : ""}>Enviar</button>
        </div>
      `;
      detailContainer.appendChild(chatCard);

      wrapper._chat = {
        messagesList: chatCard.querySelector("#messagesList"),
        messageInput: chatCard.querySelector("#messageInput"),
        sendMessageBtn: chatCard.querySelector("#sendMessageBtn"),
        orderId
      };

      if (isAdmin) {
        wrapper._chat.sendMessageBtn.onclick = () => enviarMensaje(wrapper._chat);
        wrapper._chat.messageInput.onkeydown = (e)=>{
          if (e.key==="Enter" && !e.shiftKey) {
            e.preventDefault();
            enviarMensaje(wrapper._chat);
          }
        };
      }
    }

    function listenMessages(orderId) {
      if (unsubscribeMessages) unsubscribeMessages();

      const msgsRef = collection(db,"branches",BRANCH_ID,"orders",orderId,"messages");
      const qMsgs = query(msgsRef, orderBy("createdAt","asc"));

      const wrapper = detailContainer.firstElementChild;
      if (!wrapper || !wrapper._chat) return;

      const {messagesList} = wrapper._chat;

      unsubscribeMessages = onSnapshot(qMsgs, snap=>{
        messagesList.innerHTML = "";

        if (snap.size===0) {
          messagesList.innerHTML = "<span style='opacity:0.7;'>Sin mensajes.</span>";
          return;
        }

        snap.forEach(docSnap=>{
          const m = docSnap.data();
          const div = document.createElement("div");
          const client = m.sender==="cliente";
          div.className = "msg " + (client ? "msg-cliente":"msg-mesero");
          div.innerHTML = `
            <div>${m.text}</div>
            <div class="msg-meta">${client?"Cliente":"Staff"}</div>
          `;
          messagesList.appendChild(div);
        });

        messagesList.scrollTop = messagesList.scrollHeight;
      });
    }

    async function enviarMensaje(chat) {
      const text = chat.messageInput.value.trim();
      if (!text) return;

      const msgRef = collection(db,"branches",BRANCH_ID,"orders",chat.orderId,"messages");
      await addDoc(msgRef,{
        sender:"mesero",
        text,
        createdAt:serverTimestamp()
      });

      chat.messageInput.value = "";
    }

    listenOrders();
  </script>
</body>
</html>